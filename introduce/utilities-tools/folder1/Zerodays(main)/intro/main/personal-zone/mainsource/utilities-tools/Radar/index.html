<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚úàÔ∏è Flight Radar Locator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    #controls button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      background: #1d3557;
      color: white;
      cursor: pointer;
      margin-right: 5px;
    }
    #controls button:hover { background: #457b9d; }
    #info {
      position: absolute;
      top: 50px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      min-width: 200px;
    }
    #results {
      position: absolute;
      top: 100px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
    }
    #results ul { list-style: none; padding: 0; margin: 0; }
    #results li {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    #results li:last-child { border-bottom: none; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <button onclick="locateUser()">üìç Find Me</button>
  <button onclick="fetchFlights()">üîÑ Refresh</button>
</div>
<div id="info">Loading map...</div>
<div id="results">
  <h3>Active Flights</h3>
  <ul id="flight-list"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([20, 0], 2);
  let markers = [];
  const resultsList = document.getElementById('flight-list');
  const info = document.getElementById('info');

  // Custom airplane blue icon
  const bluePlaneIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/681/681494.png",
    iconSize: [30, 30],
    iconAnchor: [15, 15],
    popupAnchor: [0, -10]
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  async function fetchFlights() {
    const url = `https://opensky-network.org/api/states/all`;

    resultsList.innerHTML = '<li>Loading...</li>';
    info.textContent = 'Fetching flight data...';

    try {
      const res = await fetch(url);
      const data = await res.json();

      markers.forEach(m => map.removeLayer(m));
      markers = [];
      resultsList.innerHTML = '';

      if (!data.states?.length) {
        resultsList.innerHTML = '<li>No flights found in this area.</li>';
        info.textContent = 'No results in view.';
        return;
      }

      let count = 0;
      data.states.forEach(flight => {
        const [icao, callsign, , lon, lat, alt, , velocity] = flight;
        if (!lat || !lon) return;

        const marker = L.marker([lat, lon], { icon: bluePlaneIcon }).addTo(map);
        const name = callsign?.trim() || 'Unknown';
        marker.bindPopup(`
          <b>${name}</b><br>
          ICAO: ${icao}<br>
          Altitude: ${alt?.toFixed(0) || 0} m<br>
          Speed: ${velocity?.toFixed(0) || 0} m/s
        `);
        markers.push(marker);

        const li = document.createElement('li');
        li.textContent = `${name} - ${alt?.toFixed(0)} m`;
        resultsList.appendChild(li);
        count++;
      });

      info.textContent = `‚úÖ ${count} flights displayed.`;

    } catch (err) {
      console.error(err);
      info.textContent = '‚ùå Error fetching flight data.';
      resultsList.innerHTML = '<li>Error fetching flights.</li>';
    }
  }

  function locateUser() {
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 7);
      fetchFlights();
    }, () => alert("Failed to get location."));
  }

  map.on('moveend', fetchFlights);
  fetchFlights();
</script>
</body>
</html>
