<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Worldwide Airplane Tracker</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0d1b2a;
    color: #cbd5e1;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100vh;
  }
  .infoBox {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(13,27,42,0.85);
    color: #cbd5e1;
    padding: 12px 16px;
    font-size: 14px;
    border-radius: 8px;
    max-width: 280px;
    z-index: 1000;
    pointer-events: none;
    line-height: 1.3;
  }
  .loading {
    position: absolute;
    top: 10px; right: 10px;
    background: rgba(13,27,42,0.85);
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: bold;
    color: limegreen;
    font-family: monospace;
    z-index: 1000;
  }
  .leaflet-popup-content-wrapper {
    background: #112240;
    color: #eee;
    border-radius: 8px;
  }
  .leaflet-popup-tip {
    background: #112240;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="infoBox" id="planeCount">Planes tracked: 0</div>
<div class="loading" id="loadingStatus">Loading data...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 8,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const planeIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/e/e9/Airplane_silhouette_icon.svg',
    iconSize: [30, 30],
    iconAnchor: [15, 15],
    popupAnchor: [0, -15]
  });

  let planesLayer = L.layerGroup().addTo(map);
  const planeCountEl = document.getElementById('planeCount');
  const loadingStatusEl = document.getElementById('loadingStatus');

  async function fetchPlanes() {
    loadingStatusEl.textContent = 'Loading data...';
    try {
      const res = await fetch('https://opensky-network.org/api/states/all');
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const data = await res.json();

      // Clear old planes
      planesLayer.clearLayers();

      if (!data.states) {
        planeCountEl.textContent = 'Planes tracked: 0';
        loadingStatusEl.textContent = 'No data available';
        return;
      }

      let count = 0;
      data.states.forEach(plane => {
        // Plane data fields: [0]icao24, [1]callsign, [2]origin_country, [3]time_position, [4]last_contact, [5]longitude, [6]latitude, [7]baro_altitude, ...
        const lat = plane[6];
        const lon = plane[5];
        if (lat === null || lon === null) return; // skip invalid coords

        count++;
        const callsign = plane[1] ? plane[1].trim() : 'N/A';
        const country = plane[2] || 'Unknown';
        const altitude = plane[7] !== null ? (plane[7] * 3.28084).toFixed(0) : 'N/A'; // meters to feet
        const velocity = plane[9] !== null ? (plane[9] * 1.94384).toFixed(0) : 'N/A'; // m/s to knots
        const heading = plane[10] !== null ? plane[10].toFixed(0) : 'N/A';

        const popupContent = `
          <b>Callsign:</b> ${callsign}<br/>
          <b>Country:</b> ${country}<br/>
          <b>Altitude:</b> ${altitude} ft<br/>
          <b>Speed:</b> ${velocity} knots<br/>
          <b>Heading:</b> ${heading}Â°
        `;

        const marker = L.marker([lat, lon], { icon: planeIcon }).bindPopup(popupContent);
        planesLayer.addLayer(marker);
      });

      planeCountEl.textContent = `Planes tracked: ${count}`;
      loadingStatusEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    } catch (error) {
      loadingStatusEl.textContent = 'Failed to load data.';
      console.error(error);
    }
  }

  fetchPlanes();
  // Update every 15 seconds
  setInterval(fetchPlanes, 15000);
</script>
</body>
</html>
