<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Global Tracker </title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
   background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSFVOZ2CsKQIPT0Lk06f5bNALaBIuEhMWppBg&s');
    color: #ff0000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }
  #map {
    height: 100vh;
    width: 100vw;
  }
  .infoBox {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0);
    padding: 12px 16px;
    font-size: 14px;
    border-radius: 8px;
    max-width: 320px;
    z-index: 1000;
  }
  .loading {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.089);
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: bold;
    color: #33ff77;
    font-family: monospace;
    z-index: 1000;
  }
  .leaflet-popup-content-wrapper {
    background: #0000001c;
    color: #ff0000;
    border-radius: 8px;
  }
  .leaflet-popup-tip {
    background: #0000002f;
  }
  #limitSelector {
    position: absolute;
    top: 60px;
    left: 10px;
    background: rgba(0, 0, 0, 0.027);
    padding: 8px 12px;
    border-radius: 8px;
    z-index: 1000;
    font-size: 14px;
    color: #ff0000;
    border: none;
    outline: none;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="infoBox" id="planeCount">Planes tracked: 0</div>
<div class="loading" id="loadingStatus">Loading data...</div>

<!-- Dropdown with "All" option -->
<select id="limitSelector" title="Select max planes to display">
  <option value="50">Show 50 planes</option>
  <option value="100" selected>Show 100 planes</option>
  <option value="200">Show 200 planes</option>
  <option value="500">Show 500 planes</option>
  <option value="all">Show ALL planes</option>
</select>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 7,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const planeIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [32, 32],
    iconAnchor: [16, 16],
    popupAnchor: [0, -16]
  });

  let planesLayer = L.layerGroup().addTo(map);
  const planeCountEl = document.getElementById('planeCount');
  const loadingStatusEl = document.getElementById('loadingStatus');
  const limitSelector = document.getElementById('limitSelector');

  let latestPlanesData = [];

  async function fetchPlanes() {
    loadingStatusEl.textContent = 'Fetching live data...';
    try {
      const response = await fetch('https://opensky-network.org/api/states/all');
      if (!response.ok) throw new Error('Network error');

      const data = await response.json();
      if (!data.states) throw new Error('No data');

      latestPlanesData = data.states.filter(plane => {
        const lat = plane[6], lon = plane[5], on_ground = plane[8];
        return lat !== null && lon !== null && !on_ground;
      });

      updateMapMarkers();
      loadingStatusEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
    } catch (e) {
      loadingStatusEl.textContent = `Error fetching data: ${e.message}`;
    }
  }

  function updateMapMarkers() {
    planesLayer.clearLayers();
    let count = 0;

    const limitValue = limitSelector.value;
    let planesToShow;

    if (limitValue === 'all') {
      planesToShow = latestPlanesData;
    } else {
      const limit = parseInt(limitValue, 10) || 100;
      planesToShow = latestPlanesData.slice(0, limit);
    }

    planesToShow.forEach(plane => {
      const [
        icao24, callsignRaw, origin_country, time_position,
        last_contact, lon, lat, baro_altitude, on_ground,
        velocity, true_track, vertical_rate, sensors, geo_altitude,
        squawk, spi, position_source
      ] = plane;

      const callsign = (callsignRaw || '').trim() || 'N/A';

      const popup = `
        <b>Callsign:</b> ${callsign}<br/>
        <b>Origin Country:</b> ${origin_country}<br/>
        <b>Altitude:</b> ${geo_altitude ? geo_altitude.toFixed(0) + ' m' : 'N/A'}<br/>
        <b>Velocity:</b> ${velocity ? (velocity * 3.6).toFixed(0) + ' km/h' : 'N/A'}<br/>
        <b>Track:</b> ${true_track ? true_track.toFixed(0) + 'Â°' : 'N/A'}<br/>
        <b>Squawk:</b> ${squawk || 'N/A'}
      `;

      const marker = L.marker([lat, lon], {icon: planeIcon}).bindPopup(popup);
      planesLayer.addLayer(marker);
      count++;
    });

    planeCountEl.textContent = `Planes tracked: ${count}`;
  }

  limitSelector.addEventListener('change', updateMapMarkers);

  fetchPlanes();
  setInterval(fetchPlanes, 1000); // Refresh every 1 seconds
</script>
</body>
</html>
