<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetScan Pro v6.9 - Infinite OSM Device Hunter + Access Scanner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');
        
        /* CSS CUSTOM PROPERTIES FOR PERFECT SCALING */
        :root {
            /* Fluid Typography Scale */
            --font-xs: clamp(0.65rem, 1.2vw, 0.8rem);
            --font-sm: clamp(0.75rem, 1.5vw, 0.9rem);
            --font-base: clamp(0.85rem, 2vw, 1rem);
            --font-lg: clamp(1rem, 2.5vw, 1.2rem);
            --font-xl: clamp(1.3rem, 3.5vw, 1.8rem);
            --font-xxl: clamp(1.6rem, 4.5vw, 2.8rem);
            
            /* Spacing Scale */
            --space-xs: clamp(4px, 1vw, 8px);
            --space-sm: clamp(6px, 1.2vw, 12px);
            --space-md: clamp(10px, 1.5vw, 16px);
            --space-lg: clamp(12px, 1.8vw, 20px);
            --space-xl: clamp(16px, 2vw, 24px);
            
            /* Sizing Scale */
            --border-radius: clamp(8px, 1.2vw, 16px);
            --border-width: clamp(1px, 0.2vw, 2px);
            --control-height: clamp(40px, 6vw, 60px);
            --button-height: clamp(44px, 7vw, 56px);
            --marker-size: clamp(24px, 3vw, 32px);
            
            /* Layout Scale */
            --container-padding: clamp(6px, 2vw, 20px);
            --panel-padding: clamp(12px, 2.5vw, 24px);
            --map-min-height: clamp(300px, 40vh, 500px);
            --devices-max-height: clamp(250px, 30vh, 400px);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            touch-action: manipulation; /* Touch-first */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Rajdhani', 'Orbitron', monospace;
            background: radial-gradient(circle at 20% 80%, #0d1b2a 0%, #1b263b 50%, #000 100%);
            color: #00ff88;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            font-size: var(--font-base);
            line-height: 1.4;
        }

        canvas { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            opacity: 0.1; 
        }

        .container { 
            max-width: 2000px; 
            margin: 0 auto; 
            padding: var(--container-padding); 
            position: relative; 
            z-index: 10; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-sm);
        }

        .header { 
            text-align: center; 
            margin-bottom: var(--space-sm); 
            flex-shrink: 0; 
        }
        .logo {
            font-size: var(--font-xxl); 
            font-weight: 900;
            background: linear-gradient(45deg, #00ff88, #00d4ff, #ff0080, #ffaa00);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            background-clip: text; 
            text-shadow: 0 0 40px rgba(0, 255, 136, 0.6);
            animation: logoGlow 3s ease-in-out infinite alternate;
            letter-spacing: clamp(-1px, -0.3vw, -2px);
            margin-bottom: var(--space-xs);
        }
        @keyframes logoGlow { 
            from { filter: drop-shadow(0 0 20px #00ff88); } 
            to { filter: drop-shadow(0 0 40px #00ff88); } 
        }
        .subtitle { 
            font-size: var(--font-sm); 
            color: #88ffaa; 
            opacity: 0.9; 
            font-weight: 500; 
        }

        .legend-toggle {
            position: absolute; 
            top: var(--space-md); 
            right: var(--space-md); 
            z-index: 1000;
            background: rgba(10, 25, 47, 0.95); 
            backdrop-filter: blur(20px);
            border: var(--border-width) solid rgba(0, 255, 136, 0.4); 
            border-radius: var(--border-radius);
            padding: var(--space-sm) var(--space-md); 
            cursor: pointer;
            font-size: var(--font-xs); 
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        .legend-toggle:hover { 
            background: rgba(0, 255, 136, 0.2); 
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .color-legend {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: var(--space-sm);
            background: rgba(10, 25, 47, 0.95); 
            backdrop-filter: blur(25px);
            border: var(--border-width) solid rgba(0, 255, 136, 0.4); 
            border-radius: var(--border-radius);
            padding: var(--space-lg); 
            margin-bottom: var(--space-md);
            display: none;
            max-height: clamp(120px, 20vh, 200px);
            overflow-y: auto;
        }
        .color-legend.show { display: grid; }
        .legend-item {
            display: flex; 
            align-items: center; 
            gap: var(--space-xs); 
            padding: var(--space-md); 
            background: rgba(0, 0, 0, 0.3); 
            border-radius: calc(var(--border-radius) / 1.5); 
            font-size: var(--font-xs);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .legend-item:hover { 
            background: rgba(0, 255, 136, 0.1); 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }
        .legend-color { 
            width: clamp(14px, 2vw, 20px); 
            height: clamp(14px, 2vw, 20px); 
            border-radius: 50%; 
            border: var(--border-width) solid rgba(255,255,255,0.3); 
            flex-shrink: 0; 
        }
        .legend-camera .legend-color { background: #ff4444; }
        .legend-server .legend-color { background: #44ff44; }
        .legend-router .legend-color { background: #4488ff; }
        .legend-wifi .legend-color { background: #ffaa44; }
        .legend-access .legend-color { background: #ff00ff; }
        .legend-label { font-weight: 600; line-height: 1.3; }

        .top-controls {
            background: rgba(10, 25, 47, 0.95); 
            backdrop-filter: blur(25px);
            border: var(--border-width) solid rgba(0, 255, 136, 0.4); 
            border-radius: var(--border-radius);
            padding: var(--panel-padding); 
            margin-bottom: var(--space-md); 
            flex-shrink: 0;
        }

        .search-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: var(--space-md); 
            align-items: end; 
        }
        .control-group { display: flex; flex-direction: column; }
        .control-label { 
            color: #88ffaa; 
            font-size: var(--font-xs); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: var(--space-xs); 
            font-weight: 500; 
        }
        .control-input {
            padding: clamp(10px, 1.8vw, 16px) clamp(12px, 2vw, 18px); 
            background: rgba(0, 0, 0, 0.7); 
            border: var(--border-width) solid rgba(0, 255, 136, 0.3);
            border-radius: calc(var(--border-radius) / 1.3); 
            color: #00ff88; 
            font-family: 'Rajdhani', monospace; 
            font-size: var(--font-sm);
            font-weight: 500; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: var(--control-height);
        }
        .control-input:focus { 
            outline: none; 
            border-color: #00ff88; 
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4); 
            transform: translateY(-1px);
        }
        .scan-btn {
            padding: clamp(12px, 2vw, 18px) clamp(20px, 3vw, 32px); 
            background: linear-gradient(45deg, #00ff88, #00d4ff); 
            border: none; 
            border-radius: calc(var(--border-radius) / 1.3);
            color: #000; 
            font-family: 'Orbitron', monospace; 
            font-weight: 700; 
            font-size: var(--font-base); 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            width: 100%; 
            margin-top: var(--space-md);
            min-height: var(--button-height);
        }
        .scan-btn:hover:not(:disabled) { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 12px 35px rgba(0, 255, 136, 0.5); 
        }
        .scan-btn:active { transform: scale(0.98); }
        .scan-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }
        .clear-btn {
            padding: clamp(10px, 1.8vw, 14px) clamp(16px, 2.5vw, 24px); 
            background: linear-gradient(45deg, #ff4444, #ff6666); 
            border: none; 
            border-radius: calc(var(--border-radius) / 1.3);
            color: #fff; 
            font-family: 'Orbitron', monospace; 
            font-weight: 700; 
            font-size: var(--font-sm); 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-transform: uppercase; 
            letter-spacing: 1.2px;
            margin-top: var(--space-sm);
            min-height: var(--control-height);
        }
        .clear-btn:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.5); 
        }
        .clear-btn:active { transform: scale(0.98); }
        .auto-toggle {
            display: flex; 
            align-items: center; 
            gap: var(--space-sm);
            margin-top: var(--space-sm); 
            font-size: var(--font-xs);
        }
        .auto-toggle input[type="checkbox"] {
            width: clamp(16px, 2.5vw, 20px); 
            height: clamp(16px, 2.5vw, 20px); 
            accent-color: #00ff88;
            cursor: pointer;
        }

        #map { 
            flex: 1 1 var(--map-min-height); 
            background: rgba(0, 20, 40, 0.9); 
            border-radius: var(--border-radius);
            border: var(--border-width) solid rgba(0, 255, 136, 0.3); 
            margin-bottom: var(--space-sm); 
            position: relative; 
            overflow: hidden;
            min-height: var(--map-min-height);
        }
        .map-overlay {
            position: absolute; 
            top: var(--space-md); 
            left: var(--space-md); 
            z-index: 1000;
            background: rgba(10, 25, 47, 0.95); 
            backdrop-filter: blur(20px);
            padding: var(--space-md) var(--space-lg); 
            border-radius: calc(var(--border-radius) / 1.3);
            border: var(--border-width) solid rgba(0, 255, 136, 0.4);
            font-size: var(--font-xs); 
            font-weight: 700;
        }
        .coords-display { 
            color: #00ff88; 
            font-family: monospace; 
            font-size: var(--font-xs);
            word-break: break-all;
        }

        .devices-panel {
            background: rgba(10, 25, 47, 0.95); 
            backdrop-filter: blur(25px);
            border: var(--border-width) solid rgba(0, 255, 136, 0.4); 
            border-radius: var(--border-radius);
            padding: var(--panel-padding); 
            flex-shrink: 0; 
            max-height: var(--devices-max-height);
            overflow: hidden;
        }

        .status-bar {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: var(--space-md) var(--space-lg); 
            background: rgba(0, 255, 136, 0.1); 
            border: var(--border-width) solid rgba(0, 255, 136, 0.3);
            border-radius: calc(var(--border-radius) / 1.3); 
            margin-bottom: var(--space-md); 
            font-weight: 700;
            font-size: var(--font-sm);
        }
        .status-loading { color: #00d4ff; }
        .status-success { color: #00ff88; }
        .status-error { color: #ff4444; }

        .devices-list { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-sm); 
            max-height: calc(var(--devices-max-height) - 80px);
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: rgba(0,255,136,0.3) transparent;
        }
        .devices-list::-webkit-scrollbar {
            width: 6px;
        }
        .devices-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .devices-list::-webkit-scrollbar-thumb {
            background: rgba(0,255,136,0.3);
            border-radius: 3px;
        }
        .device-item {
            padding: var(--space-lg); 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: calc(var(--border-radius) / 1.5); 
            border-left: calc(var(--border-width) * 3) solid #00ff88;
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            min-height: 60px;
        }
        .device-item:hover, .device-item:focus { 
            background: rgba(0, 255, 136, 0.15); 
            border-left-color: #00ff88; 
            transform: translateX(4px); 
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.2);
        }
        .device-type { 
            font-size: var(--font-xs); 
            font-weight: 700; 
            padding: var(--space-xs) var(--space-md); 
            border-radius: 20px; 
            min-width: fit-content;
        }
        .device-type.camera { 
            background: rgba(255, 68, 68, 0.3); 
            color: #ff4444; 
            border-left-color: #ff4444 !important; 
        }
        .device-type.server { 
            background: rgba(68, 255, 68, 0.3); 
            color: #44ff44; 
            border-left-color: #44ff44 !important; 
        }
        .device-type.router { 
            background: rgba(68, 136, 255, 0.3); 
            color: #4488ff; 
            border-left-color: #4488ff !important; 
        }
        .device-type.wifi { 
            background: rgba(255, 170, 68, 0.3); 
            color: #ffaa44; 
            border-left-color: #ffaa44 !important; 
        }
        .device-type.accessible { 
            background: rgba(255, 0, 255, 0.3); 
            color: #ff00ff; 
            border-left-color: #ff00ff !important; 
            animation: pulse-access 2s infinite;
        }
        @keyframes pulse-access {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.8); }
        }
        .device-name { 
            font-weight: 700; 
            font-size: var(--font-base); 
            margin-bottom: var(--space-xs); 
        }
        .device-coords { 
            font-size: var(--font-xs); 
            opacity: 0.8; 
            font-family: monospace; 
        }
        .access-badge {
            background: rgba(255, 0, 255, 0.4);
            color: #ff00ff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 700;
        }

        .panel-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: var(--space-lg); 
            padding-bottom: var(--space-md);
            border-bottom: var(--border-width) solid rgba(0, 255, 136, 0.3);
            gap: var(--space-md);
        }
        .panel-header .clear-btn {
            padding: var(--space-sm) var(--space-lg);
            font-size: var(--font-sm);
            margin-top: 0;
            flex-shrink: 0;
            min-width: clamp(120px, 20vw, 160px);
            min-height: var(--control-height);
        }

        /* ACCESS POPUP STYLES */
        .access-popup {
            background: rgba(10, 25, 47, 0.98);
            backdrop-filter: blur(30px);
            border: calc(var(--border-width) * 2) solid #ff00ff;
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 24px);
            max-width: clamp(320px, 90vw, 450px);
            font-family: 'Rajdhani', monospace;
            max-height: 90vh;
            overflow-y: auto;
        }
        .access-title {
            color: #ff00ff;
            font-size: clamp(1.1em, 4vw, 1.4em);
            font-weight: 900;
            margin-bottom: var(--space-lg);
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        .access-info {
            background: rgba(255, 0, 255, 0.1);
            padding: var(--space-md);
            border-radius: calc(var(--border-radius) / 1.5);
            margin-bottom: var(--space-lg);
            font-size: var(--font-sm);
        }
        .access-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        .access-btn {
            flex: 1;
            padding: clamp(10px, 2vw, 14px);
            border: none;
            border-radius: calc(var(--border-radius) / 1.5);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Orbitron', monospace;
            text-decoration: none;
            text-align: center;
            font-size: var(--font-sm);
            min-height: var(--control-height);
        }
        .access-btn.primary {
            background: linear-gradient(45deg, #ff00ff, #ff44ff);
            color: #000;
        }
        .access-btn.primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 0, 255, 0.6);
        }
        .access-btn.secondary {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: var(--border-width) solid rgba(0, 255, 136, 0.4);
        }
        .access-btn.secondary:hover {
            background: rgba(0, 255, 136, 0.4);
            transform: translateY(-1px);
        }

        /* ULTRA RESPONSIVE BREAKPOINTS */
        @media (max-height: 600px) {
            .container { gap: var(--space-xs); }
            #map { flex: 1 1 35vh !important; min-height: 250px !important; }
            .devices-panel { max-height: 200px !important; }
            .color-legend { max-height: 100px; }
        }

        @media (max-width: 1200px) { 
            .search-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } 
        }
        
        @media (max-width: 768px) { 
            .container { padding: calc(var(--container-padding) / 1.5); }
            .search-grid { 
                grid-template-columns: 1fr; 
                gap: var(--space-sm); 
            } 
            .top-controls, .devices-panel { padding: calc(var(--panel-padding) / 1.2); }
            .panel-header { 
                flex-direction: column; 
                gap: var(--space-sm); 
                align-items: stretch; 
            }
            .panel-header .clear-btn { width: 100%; }
            #map { margin-bottom: var(--space-xs); } 
            .legend-toggle { 
                top: var(--space-sm); 
                right: var(--space-sm); 
                font-size: 0.75em; 
                padding: var(--space-xs) var(--space-sm);
            }
        }
        
        @media (max-width: 480px) { 
            :root {
                --container-padding: 4px;
                --panel-padding: 10px;
            }
            .header { margin-bottom: var(--space-xs); }
            .logo { 
                font-size: clamp(1.4em, 6vw, 1.8em) !important; 
                letter-spacing: -1px;
            }
            .search-grid { gap: var(--space-xs); }
            .devices-list { 
                max-height: calc(var(--devices-max-height) - 60px) !important;
                gap: var(--space-xs);
            }
            .device-item { 
                padding: var(--space-md); 
                min-height: 52px;
                gap: var(--space-sm);
            }
            .access-buttons { flex-direction: column; }
            .access-btn { min-height: 48px; }
        }

        @media (max-width: 360px) {
            .container { padding: 3px; }
            .logo { font-size: 1.3em !important; }
            #map { min-height: 280px !important; }
        }

        /* Landscape Mobile Optimizations */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { display: none; }
            .top-controls { padding: var(--space-md); }
            .devices-panel { max-height: 25vh !important; }
            .color-legend { 
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
                max-height: 80px;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .legend-color { border-width: 0.5px; }
            .device-item { border-left-width: 2px; }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }

        /* Dark mode forced (already dark theme) */
        @media (prefers-color-scheme: dark) {
            :root { color-scheme: dark; }
        }
    </style>
</head>
<body>
    <canvas id="matrix-bg"></canvas>
    
    <div class="container">
        <div class="header">
            <div class="logo">NETSCAN PRO v6.9</div>
            <div class="subtitle">Infinite OSM Device Hunter ‚Ä¢ Auto-Markers on MOVE</div>
        </div>

        <!-- LEGEND -->
        <button class="legend-toggle" id="legendToggle">üìã Legend</button>

        <div class="color-legend" id="colorLegend">
            <div class="legend-item legend-camera">
                <div class="legend-color"></div>
                <span class="legend-label">üî¥ RED = Cameras<br><small>(surveillance=camera)</small></span>
            </div>
            <div class="legend-item legend-server">
                <div class="legend-color"></div>
                <span class="legend-label">üü¢ GREEN = Servers<br><small>(man_made=server)</small></span>
            </div>
            <div class="legend-item legend-router">
                <div class="legend-color"></div>
                <span class="legend-label">üîµ BLUE = Routers/Towers<br><small>(cellular towers, antennas)</small></span>
            </div>
            <div class="legend-item legend-wifi">
                <div class="legend-color"></div>
                <span class="legend-label">üü° YELLOW = WiFi/IoT<br><small>(wlan hotspots, charging)</small></span>
            </div>
            <div class="legend-item legend-access">
                <div class="legend-color"></div>
                <span class="legend-label">üü£ MAGENTA = ACCESSIBLE<br><small>(web interface detected)</small></span>
            </div>
        </div>

        <div class="top-controls">
            <div class="search-grid">
                <div class="control-group">
                    <label class="control-label">Search Location</label>
                    <input type="text" class="control-input" id="locationSearch" placeholder="Enter location...">
                </div>
                <div class="control-group">
                    <label class="control-label">Radius (km)</label>
                    <input type="number" class="control-input" id="radiusInput" value="50" min="0.1" max="999999999999" step="0.1">
                </div>
            </div>
            <div class="auto-toggle">
                <input type="checkbox" id="autoScanToggle" checked>
                <label for="autoScanToggle" style="cursor: pointer; margin: 0; color: #88ffaa;">üîÑ AUTO-SCAN + MARKERS ON MAP MOVE</label>
            </div>
            <button class="scan-btn" id="scanBtn">üéØ SCAN CURRENT AREA + MARK</button>
        </div>

        <div id="statusBar" class="status-bar" style="display: none;"></div>

        <div id="map">
            <div class="map-overlay">
                <div>üìç Current:</div>
                <div class="coords-display" id="currentCoords">0.0000, 0.0000</div>
            </div>
        </div>

        <div class="devices-panel">
            <div class="panel-header">
                <h3 style="margin: 0; font-size: clamp(1em, 2.5vw, 1.2em);">üì± Live Device Feed</h3>
                <span id="deviceCount" style="font-weight: 700; color: #00ff88;">0 found</span>
                <button class="clear-btn" id="clearDevicesBtn">üóëÔ∏è CLEAR FEED</button>
            </div>
            <div id="devicesList" class="devices-list" style="display: none;">
                <div style="text-align: center; color: #666; padding: 30px; font-size: 0.9em;">üó∫Ô∏è MOVE MAP to auto-discover devices...</div>
            </div>
        </div>
    </div>

    <script>
        class MatrixBackground {
            constructor() {
                this.canvas = document.getElementById('matrix-bg');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                this.initMatrix();
                window.addEventListener('resize', () => this.resize());
            }
            resize() { 
                this.canvas.width = window.innerWidth; 
                this.canvas.height = window.innerHeight; 
            }
            initMatrix() {
                this.cols = Math.floor(this.canvas.width / 20) * 2;
                this.drops = Array(this.cols).fill(1);
                this.animate();
            }
            animate() {
                this.ctx.fillStyle = 'rgba(0, 20, 40, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#00ff88'; 
                this.ctx.font = '15px monospace';
                for (let i = 0; i < this.drops.length; i++) {
                    const text = String.fromCharCode(0x30A0 + Math.random() * 96);
                    this.ctx.fillText(text, i * 20, this.drops[i] * 20);
                    if (this.drops[i] * 20 > this.canvas.height && Math.random() > 0.975) 
                        this.drops[i] = 0;
                    this.drops[i]++;
                }
                requestAnimationFrame(() => this.animate());
            }
        }

        class NominatimGeocoder {
            static async geocode(query) {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`
                );
                const data = await response.json();
                return data[0] ? {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    display_name: data[0].display_name
                } : null;
            }
        }

        class DeviceHunter {
            constructor() {
                this.osmApiBase = 'https://overpass-api.de/api/interpreter';
                this.center = { lat: 0, lon: 0 };
                this.currentDevices = [];
                this.allDevices = [];
                this.map = null;
                this.deviceMarkers = [];
                this.scanMarkers = [];
                this.centerMarker = null;
                this.isScanning = false;
                this.autoScanEnabled = true;
                this.moveTimeout = null;
                this.init();
                new MatrixBackground();
            }

            init() {
                this.initMap();
                this.initControls();
                this.initLegend();
            }

            initLegend() {
                document.getElementById('legendToggle').addEventListener('click', () => {
                    const legend = document.getElementById('colorLegend');
                    legend.classList.toggle('show');
                });
            }

            initMap() {
                const mapContainer = document.getElementById('map');
                this.map = L.map('map').setView([40.7128, -74.0060], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                const crosshairIcon = L.divIcon({
                    className: 'custom-crosshair',
                    html: '<div style="width: 20px; height: 20px; border: 2px solid #00ff88; border-radius: 50%; background: rgba(0,255,136,0.3); box-shadow: 0 0 15px rgba(0,255,136,0.8);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                this.centerMarker = L.marker([this.center.lat, this.center.lon], {
                    icon: crosshairIcon
                }).addTo(this.map);

                this.map.on('move', () => {
                    const center = this.map.getCenter();
                    this.center = { lat: center.lat, lon: center.lon };
                    this.centerMarker.setLatLng([this.center.lat, this.center.lon]);
                    this.updateCoordsDisplay();
                });

                this.map.on('moveend', () => {
                    if (this.autoScanEnabled && !this.isScanning) {
                        this.scanWithMarkers();
                    }
                });

                this.map.on('click', (e) => {
                    this.center = { lat: e.latlng.lat, lon: e.latlng.lng };
                    this.centerMarker.setLatLng([this.center.lat, this.center.lon]);
                    this.updateCoordsDisplay();
                    
                    if (this.autoScanEnabled && !this.isScanning) {
                        this.scanWithMarkers();
                    }
                });

                window.addEventListener('resize', () => {
                    setTimeout(() => this.map?.invalidateSize(), 100);
                });
            }

            updateCoordsDisplay() {
                document.getElementById('currentCoords').textContent = 
                    `${this.center.lat.toFixed(5)}, ${this.center.lon.toFixed(5)}`;
            }

            initControls() {
                document.getElementById('scanBtn').addEventListener('click', () => this.scanWithMarkers());
                document.getElementById('clearDevicesBtn').addEventListener('click', () => this.clearLiveFeed());
                document.getElementById('autoScanToggle').addEventListener('change', (e) => {
                    this.autoScanEnabled = e.target.checked;
                    if (this.autoScanEnabled) {
                        this.scanWithMarkers();
                    }
                });
                
                document.getElementById('locationSearch').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.geocodeAndScan();
                });

                document.getElementById('radiusInput').addEventListener('input', () => {
                    if (this.autoScanEnabled && !this.isScanning) {
                        this.scanWithMarkers();
                    }
                });
            }

            clearLiveFeed() {
                this.deviceMarkers.forEach(marker => this.map?.removeLayer(marker));
                this.scanMarkers.forEach(marker => this.map?.removeLayer(marker));
                this.deviceMarkers = [];
                this.scanMarkers = [];
                
                this.currentDevices = [];
                this.allDevices = [];
                
                document.getElementById('deviceCount').textContent = '0 found';
                const list = document.getElementById('devicesList');
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 30px; font-size: 0.9em;">üó∫Ô∏è MOVE MAP to auto-discover devices...</div>';
                list.style.display = 'block';
                
                this.showStatus('üóëÔ∏è Live device feed cleared ‚Ä¢ Ready to scan', 'success');
            }

            async geocodeAndScan() {
                const query = document.getElementById('locationSearch').value;
                if (!query) return;
                
                this.showStatus('üîç Geocoding location...', 'loading');
                try {
                    const coords = await NominatimGeocoder.geocode(query);
                    if (coords) {
                        this.center = { lat: coords.lat, lon: coords.lon };
                        if (this.map && this.centerMarker) {
                            this.centerMarker.setLatLng([coords.lat, coords.lon]);
                            this.map.setView([coords.lat, coords.lon], 13);
                        }
                        await this.sleep(300);
                        this.scanWithMarkers();
                    } else {
                        this.showStatus('Location not found', 'error');
                    }
                } catch (error) {
                    this.showStatus('Geocoding failed', 'error');
                }
            }

            async scanWithMarkers() {
                if (this.isScanning) return;
                
                const lat = this.center.lat;
                const lon = this.center.lon;
                let radius = parseFloat(document.getElementById('radiusInput').value) || 50;

                if (!lat || !lon) {
                    this.showStatus('Invalid coordinates', 'error');
                    return;
                }

                this.isScanning = true;
                this.showStatus(`üéØ Scanning ${radius.toLocaleString()}km around ${lat.toFixed(4)}, ${lon.toFixed(4)}...`, 'loading');
                document.getElementById('scanBtn').disabled = true;
                document.getElementById('clearDevicesBtn').disabled = true;

                try {
                    const devices = radius > 100 ? 
                        await this.fetchDevicesInfinite(lat, lon, radius) : 
                        await this.fetchDevices(lat, lon, radius);
                    
                    this.currentDevices = devices;
                    this.allDevices.push(...devices);
                    this.displayDevices(devices);
                    this.showColorCodedMarkers(devices);
                    this.checkAccessPoints(devices);
                    
                    const radiusDisplay = radius > 1000000 ? `${(radius/1000000).toFixed(0)}M km` : 
                                        radius > 1000 ? `${(radius/1000).toFixed(0)}K km` : 
                                        `${radius}km`;
                    this.showStatus(`‚úÖ Found ${devices.length} devices (${radiusDisplay})`, 'success');
                } catch (error) {
                    console.error('Scan failed:', error);
                    this.showStatus(`‚ùå ${error.message}`, 'error');
                } finally {
                    document.getElementById('scanBtn').disabled = false;
                    document.getElementById('clearDevicesBtn').disabled = false;
                    this.isScanning = false;
                }
            }

            async fetchDevicesInfinite(lat, lon, radius) {
                const bbox = this.calculateBBox(lat, lon, Math.min(radius, 500));
                const query = this.buildInfiniteQuery(bbox);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                try {
                    const response = await fetch(this.osmApiBase, {
                        method: 'POST',
                        body: new URLSearchParams({ data: query }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return this.parseDevices(data.elements || []);
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            async fetchDevices(lat, lon, radius) {
                const bbox = this.calculateBBox(lat, lon, Math.min(radius, 50));
                const query = this.buildBroadQuery(bbox);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000);

                try {
                    const response = await fetch(this.osmApiBase, {
                        method: 'POST',
                        body: new URLSearchParams({ data: query }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return this.parseDevices(data.elements || []);
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            calculateBBox(lat, lon, radiusKm) {
                const effectiveRadius = Math.min(radiusKm, 1000);
                const latDelta = effectiveRadius / 111.0;
                const lonDelta = effectiveRadius / (111.0 * Math.cos((lat * Math.PI) / 180));
                return { 
                    south: Math.max(-90, lat - latDelta), 
                    north: Math.min(90, lat + latDelta), 
                    west: Math.max(-180, lon - lonDelta), 
                    east: Math.min(180, lon + lonDelta) 
                };
            }

            buildInfiniteQuery(bbox) {
                return `[out:json][timeout:40];(
                    node["surveillance"="camera"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["amenity"="surveillance"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["man_made"~"server|tower|mast|antenna|communications_tower"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["communication:cellular"="yes"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    way["internet_access"="wlan"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["internet_access"="wlan"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["amenity"~"vending_machine|charging_station|bbq"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["device"]?(bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                );out center 300;`;
            }

            buildBroadQuery(bbox) {
                return `[out:json][timeout:30];(
                    node["surveillance"="camera"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["amenity"="surveillance"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["man_made"~"server|tower|mast|antenna"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["communication:cellular"="yes"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    way["internet_access"="wlan"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["internet_access"="wlan"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                    node["amenity"~"vending_machine|charging_station"](bbox=${bbox.south},${bbox.west},${bbox.north},${bbox.east});
                );out center 150;`;
            }

            parseDevices(elements) {
                return elements.map(el => {
                    const tags = el.tags || {};
                    const type = this.classifyDevice(tags);
                    const name = tags.name || tags['name:en'] || tags.operator || tags['brand'] || `${type} ${el.id}`;
                    
                    const device = {
                        id: `OSM-${el.id}`,
                        type,
                        name,
                        lat: el.lat || el.center?.lat || 0,
                        lon: el.lon || el.center?.lon || 0,
                        tags,
                        distance: this.haversine(this.center.lat, this.center.lon, el.lat || el.center?.lat, el.lon || el.center?.lon),
                        accessible: false,
                        accessUrls: [],
                        website: tags.website || tags.url || tags['contact:website']
                    };
                    
                    this.enrichAccessPoints(device);
                    return device;
                }).filter(d => d.lat && d.lon && (d.name.length > 2 || d.tags.surveillance))
                  .slice(0, 200);
            }

            enrichAccessPoints(device) {
                const commonPorts = ['80', '8080', '443', '8443', '81'];
                const commonPaths = ['admin', 'login', 'panel', 'web', 'config', 'status'];
                
                if (device.tags['brand'] === 'Ubiquiti' || device.tags.manufacturer?.includes('Ubiquiti')) {
                    device.accessUrls.push(`http://${device.tags.hostname || 'device'}.local`);
                    device.accessUrls.push(`http://${device.id}.local`);
                }
                
                if (device.tags['internet_access'] === 'wlan') {
                    device.accessUrls.push(`http://captive.portal.local`);
                }
                
                commonPorts.forEach(port => {
                    device.accessUrls.push(`http://${device.tags.hostname || device.id}:${port}`);
                });
            }

            async checkAccessPoints(devices) {
                devices.forEach(device => {
                    if (device.website || device.accessUrls.length > 0 || 
                        device.tags['brand']?.match(/Ubiquiti|TP-Link|Cisco|D-Link|Netgear/)) {
                        device.accessible = true;
                    }
                });
            }

            classifyDevice(tags) {
                if (tags.surveillance === 'camera' || tags.amenity === 'surveillance') return 'camera';
                if (tags['man_made']?.includes('server') || tags.amenity === 'server') return 'server';
                if (tags['man_made']?.match(/tower|mast|antenna|communications_tower/) || tags['communication:cellular'] === 'yes') return 'router';
                if (tags['internet_access'] === 'wlan') return 'wifi';
                if (tags.amenity?.match(/vending|charging/)) return 'iot';
                return 'device';
            }

            haversine(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            showColorCodedMarkers(devices) {
                this.deviceMarkers.forEach(marker => this.map?.removeLayer(marker));
                this.scanMarkers.forEach(marker => this.map?.removeLayer(marker));
                this.deviceMarkers = [];
                this.scanMarkers = [];

                const colors = {
                    camera: { fill: '#ff4444', stroke: '#ff6666' },
                    server: { fill: '#44ff44', stroke: '#66ff66' },
                    router: { fill: '#4488ff', stroke: '#66aaff' },
                    wifi: { fill: '#ffaa44', stroke: '#ffcc66' },
                    iot: { fill: '#ffaa00', stroke: '#ffcc00' },
                    device: { fill: '#00ff88', stroke: '#00ffaa' },
                    accessible: { fill: '#ff00ff', stroke: '#ff44ff' }
                };

                devices.slice(0, 80).forEach((device, index) => {
                    const color = colors[device.accessible ? 'accessible' : device.type] || colors.device;
                    
                    const scanMarker = L.circleMarker([device.lat, device.lon], {
                        radius: device.accessible ? 9 + (index % 4) : 7 + (index % 4),
                        fillColor: color.fill,
                        color: color.stroke,
                        weight: device.accessible ? 3 : 2,
                        opacity: 0.9,
                        fillOpacity: device.accessible ? 0.85 : 0.8
                    }).addTo(this.map);

                    let pulse = 0;
                    const pulseInterval = setInterval(() => {
                        pulse += 0.2;
                        scanMarker.setStyle({
                            radius: (device.accessible ? 9 : 7) + Math.sin(pulse) * 2 + (index % 4),
                            fillOpacity: (device.accessible ? 0.7 : 0.6) + Math.sin(pulse) * 0.2
                        });
                    }, 250);

                    scanMarker.on('remove', () => clearInterval(pulseInterval));
                    this.scanMarkers.push(scanMarker);

                    scanMarker.on('click', () => {
                        this.map.setView([device.lat, device.lon], 18);
                        this.showAccessPopup(device);
                    });
                });

                devices.slice(0, 25).forEach(device => {
                    const color = colors[device.accessible ? 'accessible' : device.type] || colors.device;
                    
                    const infoMarker = L.circleMarker([device.lat, device.lon], {
                        radius: device.accessible ? 14 : 11,
                        fillColor: color.fill,
                        color: '#ffffff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(this.map)
                      .bindPopup(`
                        <b style="color: ${color.fill};">üéØ ${device.name}</b><br>
                        Type: <span style="color: ${color.fill};">${device.type.toUpperCase()}${device.accessible ? ' üîì' : ''}</span><br>
                        üìç ${device.lat.toFixed(5)}, ${device.lon.toFixed(5)}<br>
                        üìè ${device.distance.toFixed(1)}km away
                      `);

                    infoMarker.on('click', () => {
                        this.map.setView([device.lat, device.lon], 18);
                        this.showAccessPopup(device);
                    });
                    this.deviceMarkers.push(infoMarker);
                });

                if (this.scanMarkers.length > 0) {
                    try {
                        const bounds = L.latLngBounds(
                            this.scanMarkers.map(m => m.getLatLng())
                        );
                        this.map.fitBounds(bounds, { 
                            padding: [40, 40],
                            maxZoom: 16
                        });
                    } catch (e) {
                        console.warn('Bounds fit failed:', e);
                    }
                }
            }

            showAccessPopup(device) {
                if (!device.accessible && !device.website && !device.accessUrls.length) return;
                
                const popupContent = `
                    <div class="access-popup">
                        <div class="access-title">üîì ${device.name}</div>
                        <div class="access-info">
                            <strong>Type:</strong> ${device.type.toUpperCase()}<br>
                            <strong>Coords:</strong> ${device.lat.toFixed(5)}, ${device.lon.toFixed(5)}<br>
                            <strong>Distance:</strong> ${device.distance.toFixed(1)}km
                        </div>
                        ${device.website ? `<div class="access-info"><strong>üåê Official:</strong> <a href="${device.website}" target="_blank" style="color: #00ff88;">${device.website}</a></div>` : ''}
                        <div class="access-buttons">
                            ${device.accessUrls.slice(0, 4).map(url => 
                                `<a href="${url}" target="_blank" class="access-btn primary">üì± ${url.split('/')[2] || url}</a>`
                            ).join('')}
                            ${device.accessible && !device.accessUrls.length ? 
                                `<button class="access-btn secondary" onclick="navigator.clipboard.writeText('${device.lat.toFixed(5)}, ${device.lon.toFixed(5)}')">üìã Copy Coords</button>` : ''
                            }
                        </div>
                    </div>
                `;
                
                L.popup({ maxWidth: 420 })
                    .setLatLng([device.lat, device.lon])
                    .setContent(popupContent)
                    .openOn(this.map);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            displayDevices(devices) {
                document.getElementById('deviceCount').textContent = `${this.allDevices.length} total ‚Ä¢ ${devices.length} new`;
                const list = document.getElementById('devicesList');
                
                if (devices.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #666; padding: 30px; font-size: 0.9em;">üó∫Ô∏è MOVE MAP to auto-discover devices...</div>';
                    list.style.display = 'block';
                    return;
                }

                list.innerHTML = devices.sort((a,b) => (b.accessible ? 1 : 0) - (a.accessible ? 1 : 0) || a.distance - b.distance)
                    .map(device => `
                        <div class="device-item device-type-${device.accessible ? 'accessible' : device.type}" 
                             onclick="if(hunter) hunter.centerOnDevice('${device.id}')" 
                             title="${JSON.stringify(device.tags).slice(0,200)}...">
                            <div>
                                <div class="device-name">${device.name}</div>
                                <div class="device-coords">${device.lat.toFixed(5)}, ${device.lon.toFixed(5)} ‚Ä¢ ${device.distance.toFixed(1)}km
                                    ${device.accessible ? '<span class="access-badge">üîì ACCESS</span>' : ''}
                                </div>
                            </div>
                            <div class="device-type device-type-${device.accessible ? 'accessible' : device.type}">
                                ${device.accessible ? 'üîì ACCESS' : device.type.toUpperCase()}
                            </div>
                        </div>
                    `).join('');
                list.style.display = 'flex';
            }

            centerOnDevice(deviceId) {
                const device = [...this.currentDevices, ...this.allDevices].find(d => d.id === deviceId);
                if (device && this.map) {
                    this.map.setView([device.lat, device.lon], 18, { animate: true });
                    this.showAccessPopup(device);
                }
            }

            showStatus(message, type) {
                const statusBar = document.getElementById('statusBar');
                statusBar.innerHTML = `<div class="status-${type}">${message}</div>`;
                statusBar.style.display = 'flex';
                setTimeout(() => {
                    if (statusBar) statusBar.style.display = 'none';
                }, 4000);
            }
        }

        let hunter;
        document.addEventListener('DOMContentLoaded', () => {
            hunter = new DeviceHunter();
            window.hunter = hunter;
        });
    </script>
</body>
</html>