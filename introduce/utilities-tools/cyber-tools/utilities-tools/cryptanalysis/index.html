<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Frequency Analysis Tool â€” Cyber Tools Toolkit</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: "Segoe UI", Roboto, system-ui, -apple-system;
    background:black;color:#c58b00;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
  }

  /* background video */
  video.bg-video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:-3;filter:brightness(.45) contrast(1.05)}

  nav{
    width:100%;background:rgba(0,0,0,0.6);border-bottom:1px solid #c58b00;padding:.8rem 1.2rem;
    display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;z-index:20;
  }
  .brand{font-weight:700;color:#ffc107;font-size:1.15rem}
  .music-toggle{background:transparent;border:1px solid #c58b00;color:#c58b00;padding:6px 10px;border-radius:8px;cursor:pointer}
  .music-toggle.playing{background:linear-gradient(90deg,#00d4ff,#c58b00);color:#000}

  .container{max-width:1200px;margin:100px auto 40px;padding:18px;background:rgba(0,0,0,0.45);border:1px solid #c58b00;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}

  h1{color:#ffc107;text-align:left;margin-bottom:8px}
  .top-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .panel{background:rgba(0,0,0,0.35);padding:12px;border-radius:10px;border:1px solid #c58b00;color:#ffd77a}
  textarea, input, select{
    width:100%;padding:10px;border-radius:8px;border:1px solid #c58b00;background:#0b0b0b;color:#ffc107;margin-top:6px;
  }
  textarea{min-height:160px;resize:vertical;font-family:monospace}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{background:rgba(0,0,0,0.6);border:1px solid #c58b00;color:#c58b00;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:hover{background:#c58b00;color:#000}
  .small{font-size:13px;color:#ffd77a}

  .grid{display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .chart-wrapper{height:300px;background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;border:1px solid rgba(197,139,0,0.14)}
  canvas#freqChart{width:100%;height:100%}

  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px 8px;border-bottom:1px dashed rgba(197,139,0,0.08);text-align:left;color:#dfffe8;font-family:monospace;font-size:13px}
  th{color:#ffd77a}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .stats{margin-top:8px;color:#9fffcf;font-size:14px;white-space:pre-line}

  footer{text-align:center;padding:14px;color:#c58b00;margin-top:18px}
</style>
</head>
<body>

<video class="bg-video" autoplay loop muted playsinline>
  <source src="background/1761817527453041720p.mp4" type="video/mp4">
</video>

<audio id="bg-music" loop>
  <source src="background/Programming___Coding___Hacking_music_vol.18__ANONYMOUS_HEADQUARTERS_(48k).mp3" type="audio/mpeg">
</audio>

<nav>
  <div class="brand">Frequency Analysis Tool</div>
  <button id="musicToggle" class="music-toggle">Play Music</button>
</nav>

<div class="container">
  <h1>ðŸ”Ž Frequency Analysis</h1>
  <div class="small">Paste text or upload a file, tune options, then analyze frequencies, n-grams, entropy, index of coincidence, chi-square vs English, and try Caesar suggestions.</div>

  <div style="margin-top:12px" class="panel">
    <label>Input text (paste or drop):</label>
    <textarea id="inputText" placeholder="Paste ciphertext, normal text, or upload a file using the file button..."></textarea>

    <div class="controls">
      <input type="file" id="fileInput" accept=".txt,text/plain" />
      <button id="loadFileBtn" class="btn">Load File</button>
      <button id="clearBtn" class="btn">Clear</button>
      <button id="analyzeBtn" class="btn">Analyze</button>
      <button id="copyBtn" class="btn">Copy Results</button>
      <button id="csvBtn" class="btn">Download CSV</button>
    </div>

    <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
      <div style="width:220px">
        <label>Mode:</label>
        <select id="modeSelect">
          <option value="letters">Letters only (Aâ€“Z)</option>
          <option value="all">All characters</option>
        </select>
      </div>

      <div style="width:220px">
        <label>Case:</label>
        <select id="caseSelect">
          <option value="upper">Uppercase (Aâ†’Z)</option>
          <option value="lower">Lowercase (aâ†’z)</option>
          <option value="preserve">Preserve case</option>
        </select>
      </div>

      <div style="width:180px">
        <label>Ignore spaces/punc:</label>
        <select id="ignoreSelect">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>

      <div style="width:180px">
        <label>Normalize diacritics:</label>
        <select id="normSelect">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- left: stats, tables -->
    <div>
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Character Frequencies</strong>
          <div class="small">Top characters shown; click header to sort</div>
        </div>

        <div class="chart-wrapper" id="chartWrapper">
          <canvas id="freqChart"></canvas>
        </div>

        <table id="freqTable" aria-live="polite">
          <thead><tr><th>Char</th><th>Count</th><th>Percent</th></tr></thead>
          <tbody></tbody>
        </table>

      </div>

      <div class="panel" style="margin-bottom:12px">
        <strong>Digrams (2-grams)</strong>
        <table id="digramTable"><thead><tr><th>2-gram</th><th>Count</th><th>Percent</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="panel">
        <strong>Trigrams (3-grams)</strong>
        <table id="trigramTable"><thead><tr><th>3-gram</th><th>Count</th><th>Percent</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- right: metrics & Caesar suggestions -->
    <div>
      <div class="panel" style="margin-bottom:12px">
        <strong>Statistics</strong>
        <div class="stats" id="statsBox">No analysis yet.</div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <strong>Chi-square vs English (Aâ€“Z)</strong>
        <div id="chiBox" class="small">â€”</div>
      </div>

      <div class="panel">
        <strong>Caesar shift suggestions</strong>
        <div id="caesarBox" class="small">â€”</div>
      </div>
    </div>
  </div>
</div>

<footer>Â© 2025 Cyber Tools Toolkit â€” Frequency Analysis</footer>

<script>
/* ======= Music toggle behavior ======= */
const bgAudio = document.getElementById('bg-music');
const musicToggle = document.getElementById('musicToggle');
musicToggle.addEventListener('click', async () => {
  try {
    if (bgAudio.paused) { await bgAudio.play(); musicToggle.classList.add('playing'); musicToggle.textContent='Pause Music'; }
    else { bgAudio.pause(); musicToggle.classList.remove('playing'); musicToggle.textContent='Play Music'; }
  } catch(e) {
    console.warn('Audio play blocked', e);
  }
});
// attempt auto-play after first click gesture
window.addEventListener('click', ()=>{ bgAudio.play().catch(()=>{}); }, { once: true });

/* ======= Utilities & English frequency table ======= */
const ENGLISH_FREQ = {
  A: 8.167, B:1.492, C:2.782, D:4.253, E:12.702, F:2.228, G:2.015, H:6.094, I:6.966, J:0.153,
  K:0.772, L:4.025, M:2.406, N:6.749, O:7.507, P:1.929, Q:0.095, R:5.987, S:6.327, T:9.056,
  U:2.758, V:0.978, W:2.360, X:0.150, Y:1.974, Z:0.074
};

function sanitizeText(text, opts) {
  if (opts.norm) {
    // normalize diacritics to base characters
    text = text.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
  }
  if (opts.case === 'upper') text = text.toUpperCase();
  else if (opts.case === 'lower') text = text.toLowerCase();
  // remove spaces/punctuation if requested
  if (opts.ignore) {
    text = text.replace(/[\s\W_]+/g, ''); // remove non-word characters
  }
  return text;
}

function isLetter(ch) {
  return /^[A-Za-z]$/.test(ch);
}

/* ======= Core analysis functions ======= */
function analyze(text, options={mode:'letters', case:'upper', ignore:true, norm:true}) {
  const raw = sanitizeText(text, {case: options.case, ignore: options.ignore, norm: options.norm});
  const data = options.mode === 'letters' ? raw.replace(/[^A-Za-z]/g, '') : raw;
  const counts = new Map();
  const total = data.length;

  for (let ch of data) {
    counts.set(ch, (counts.get(ch) || 0) + 1);
  }

  // char frequency sorted
  const freqArray = Array.from(counts.entries()).sort((a,b) => b[1] - a[1]);

  // digrams & trigrams
  const digrams = new Map();
  const trigrams = new Map();
  for (let i=0;i<data.length-1;i++){
    const d = data.slice(i,i+2);
    if (d.length===2) digrams.set(d, (digrams.get(d)||0)+1);
  }
  for (let i=0;i<data.length-2;i++){
    const t = data.slice(i,i+3);
    if (t.length===3) trigrams.set(t, (trigrams.get(t)||0)+1);
  }
  const digramArr = Array.from(digrams.entries()).sort((a,b)=>b[1]-a[1]);
  const trigramArr = Array.from(trigrams.entries()).sort((a,b)=>b[1]-a[1]);

  // entropy
  let entropy = 0;
  for (let [,cnt] of counts) {
    const p = cnt / total;
    entropy -= p * (Math.log2(p) || 0);
  }

  // Index of coincidence (IC)
  let ic = 0;
  if (total > 1) {
    let sum = 0;
    for (let [,cnt] of counts) sum += cnt*(cnt-1);
    ic = sum / (total*(total-1));
  }

  // Chi-square vs English only if letters mode or can map letter frequencies
  let chiValue = null, chiP = null;
  if (options.mode === 'letters') {
    // compute expected counts for A-Z based on english freq and compare on uppercase
    const totalLetters = total;
    const observed = {};
    for (let L of 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') observed[L] = 0;
    for (let [ch,cnt] of counts) {
      const C = ch.toUpperCase();
      if (observed.hasOwnProperty(C)) observed[C] = cnt;
    }
    let chi = 0;
    for (let L of Object.keys(ENGLISH_FREQ)) {
      const expected = ENGLISH_FREQ[L] / 100 * totalLetters;
      const obs = observed[L] || 0;
      chi += ((obs - expected)**2) / (expected || 1);
    }
    chiValue = chi;
    // approximate p-value from chi-square with df=25 -> use exp(-chi/2) as rough approx for large chi
    chiP = Math.exp(-chi/2);
  }

  return {
    total, freqArray, digramArr, trigramArr, entropy, ic, chiValue, chiP
  };
}

/* ======= Chart drawing code (canvas) ======= */
const canvas = document.getElementById('freqChart');
const ctx = canvas.getContext('2d');

function drawChart(freqArray) {
  // resize canvas to wrapper size
  const wrapper = document.getElementById('chartWrapper');
  const rect = wrapper.getBoundingClientRect();
  canvas.width = rect.width * devicePixelRatio;
  canvas.height = rect.height * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,rect.width,rect.height);

  const padding = {left:10, right:10, top:18, bottom:28};
  const w = rect.width - padding.left - padding.right;
  const h = rect.height - padding.top - padding.bottom;
  if (!freqArray.length) {
    ctx.fillStyle = '#ffd77a';
    ctx.fillText('No data', padding.left+10, padding.top+20);
    return;
  }

  // only plot top 20 items or fewer
  const topN = Math.min(20, freqArray.length);
  const items = freqArray.slice(0, topN);
  const maxCount = items[0][1];

  const barW = w / topN * 0.75;
  const gap = (w - barW*topN) / (topN-1 || 1);

  ctx.font = '12px monospace';
  for (let i=0;i<items.length;i++){
    const [ch,cnt] = items[i];
    const x = padding.left + i*(barW+gap);
    const barH = (cnt / maxCount) * h;
    const y = padding.top + (h - barH);

    // bar
    const grad = ctx.createLinearGradient(x, y, x, y+barH);
    grad.addColorStop(0, '#00d4ff');
    grad.addColorStop(1, '#c58b00');
    ctx.fillStyle = grad;
    roundRect(ctx, x, y, barW, barH, 4, true, false);

    // label
    ctx.fillStyle = '#ffd77a';
    const label = ch.length>1 ? (ch) : ch;
    const txtW = ctx.measureText(label).width;
    ctx.fillText(label, x + (barW - txtW)/2, padding.top + h + 16);
    // count text above bar
    const countText = cnt.toString();
    const ctW = ctx.measureText(countText).width;
    ctx.fillText(countText, x + (barW-ctW)/2, y - 6);
  }
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if (typeof r === 'undefined') r = 5;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

/* ======= UI wiring ======= */
const inputText = document.getElementById('inputText');
const fileInput = document.getElementById('fileInput');
const loadFileBtn = document.getElementById('loadFileBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const copyBtn = document.getElementById('copyBtn');
const csvBtn = document.getElementById('csvBtn');

const freqTableBody = document.querySelector('#freqTable tbody');
const digramBody = document.querySelector('#digramTable tbody');
const trigramBody = document.querySelector('#trigramTable tbody');

const statsBox = document.getElementById('statsBox');
const chiBox = document.getElementById('chiBox');
const caesarBox = document.getElementById('caesarBox');

loadFileBtn.addEventListener('click', async ()=>{
  if (!fileInput.files || !fileInput.files[0]) return alert('Choose a text file first.');
  const f = fileInput.files[0];
  const txt = await f.text();
  inputText.value = txt;
});

clearBtn.addEventListener('click', ()=>{
  inputText.value = '';
  freqTableBody.innerHTML = '';
  digramBody.innerHTML = '';
  trigramBody.innerHTML = '';
  statsBox.textContent = 'No analysis yet.';
  chiBox.textContent = 'â€”';
  caesarBox.textContent = 'â€”';
  drawChart([]);
});

analyzeBtn.addEventListener('click', ()=> {
  const opts = {
    mode: document.getElementById('modeSelect').value,
    case: document.getElementById('caseSelect').value,
    ignore: document.getElementById('ignoreSelect').value === 'yes',
    norm: document.getElementById('normSelect').value === 'yes'
  };
  const text = inputText.value || '';
  if (!text) return alert('Paste or load some text first.');
  const res = analyze(text, opts);
  renderResults(res, opts);
});

copyBtn.addEventListener('click', ()=>{
  const out = assembleTextOutput();
  navigator.clipboard.writeText(out).then(()=> alert('Results copied to clipboard.'));
});

csvBtn.addEventListener('click', ()=> {
  const rows = [['char','count','percent']];
  const tbody = freqTableBody.querySelectorAll('tr');
  for (let r of tbody) {
    const ch = r.children[0].textContent;
    const cnt = r.children[1].textContent;
    const pct = r.children[2].textContent;
    rows.push([ch, cnt, pct]);
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'freq.csv'; document.body.appendChild(a); a.click(); a.remove();
});

/* ======= Render functions ======= */
function renderResults(res, opts) {
  // freq table
  freqTableBody.innerHTML = '';
  const total = res.total || 0;
  for (let [ch,cnt] of res.freqArray) {
    const tr = document.createElement('tr');
    const pct = total ? (cnt/total*100).toFixed(3)+'%' : '0%';
    tr.innerHTML = `<td>${escapeHtml(ch)}</td><td>${cnt}</td><td>${pct}</td>`;
    freqTableBody.appendChild(tr);
  }
  // digrams
  digramBody.innerHTML = '';
  for (let i=0;i<Math.min(30, res.digramArr.length); i++){
    const [dg,cnt] = res.digramArr[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(dg)}</td><td>${cnt}</td><td>${(cnt/res.total*100).toFixed(3)}%</td>`;
    digramBody.appendChild(tr);
  }
  // trigrams
  trigramBody.innerHTML = '';
  for (let i=0;i<Math.min(30, res.trigramArr.length); i++){
    const [tg,cnt] = res.trigramArr[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(tg)}</td><td>${cnt}</td><td>${(cnt/res.total*100).toFixed(3)}%</td>`;
    trigramBody.appendChild(tr);
  }

  // stats box
  const statsText = [
    `Total symbols analyzed: ${res.total}`,
    `Entropy (bits/symbol): ${res.entropy.toFixed(4)}`,
    `Index of Coincidence (IC): ${res.ic.toFixed(6)}${res.ic>0.06? ' (close to plaintext English)': ''}`,
  ].join('\n');
  statsBox.textContent = statsText;

  // chi box
  if (res.chiValue !== null) {
    chiBox.textContent = `Chi-square: ${res.chiValue.toFixed(3)}\nApprox p (exp): ${res.chiP.toFixed(5)}\nLower p implies divergence from English letter distribution.`;
  } else {
    chiBox.textContent = 'Chi-square not available for current mode.';
  }

  // chart
  drawChart(res.freqArray);

  // caesar suggestions
  if (opts.mode === 'letters') {
    const suggestions = caesarSuggest(inputText.value, opts);
    caesarBox.innerHTML = '';
    suggestions.slice(0,6).forEach(s => {
      const el = document.createElement('div');
      el.className = 'small';
      el.style.marginBottom = '6px';
      el.innerHTML = `<strong>Shift ${s.shift}:</strong> chi=${s.chi.toFixed(3)} â€” sample: ${escapeHtml(s.sample.slice(0,200))}`;
      caesarBox.appendChild(el);
    });
  } else {
    caesarBox.textContent = 'Switch to Letters mode to see Caesar suggestions.';
  }
}

/* ======= Caesar brute force & scoring ======= */
function caesarSuggest(text, opts) {
  const prepared = sanitizeText(text, {case: 'upper', ignore: opts.ignore, norm: opts.norm}).replace(/[^A-Z]/g,'');
  const results = [];
  for (let shift=0; shift<26; shift++){
    let transformed = '';
    for (let c of prepared) {
      const code = ((c.charCodeAt(0) - 65 - shift + 26) % 26) + 65;
      transformed += String.fromCharCode(code);
    }
    // compute letter frequency counts and chi-square vs English
    const counts = {};
    for (let L of 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') counts[L]=0;
    for (let ch of transformed) counts[ch]++;
    let chi = 0;
    for (let L of Object.keys(ENGLISH_FREQ)) {
      const expected = ENGLISH_FREQ[L]/100 * transformed.length;
      const obs = counts[L] || 0;
      chi += ((obs - expected)**2) / (expected || 1);
    }
    // push sample (first 200 chars)
    results.push({shift, chi, sample: transformed});
  }
  results.sort((a,b)=>a.chi - b.chi); // lower chi => closer to expected english -> candidate plaintext
  return results;
}

/* ======= Helpers ======= */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function assembleTextOutput(){
  let out = 'Frequency Analysis Results\n\n';
  out += document.getElementById('statsBox').textContent + '\n\n';
  out += 'Top characters:\n';
  const rows = freqTableBody.querySelectorAll('tr');
  for (let r of rows) {
    out += r.children[0].textContent + '\t' + r.children[1].textContent + '\t' + r.children[2].textContent + '\n';
  }
  return out;
}

/* initial empty chart */
drawChart([]);

/* handle window resize for canvas */
let resizeTimer;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> {
    // redraw last chart using currently displayed freq table
    const arr = Array.from(document.querySelectorAll('#freqTable tbody tr')).map(tr => [tr.children[0].textContent, Number(tr.children[1].textContent)]);
    drawChart(arr);
  }, 200);
});
</script>
</body>
</html>
